{
  "name": "ğŸš€ E-Commerce Product Research V4 (Fixed)",
  "nodes": [
    {
      "parameters": {},
      "id": "node-trigger",
      "name": "ğŸš€ Start Research",
      "type": "n8n-nodes-base.manualTrigger",
      "typeVersion": 1,
      "position": [250, 400]
    },
    {
      "parameters": {
        "values": {
          "string": [
            {
              "name": "product_keyword",
              "value": "wireless earbuds"
            },
            {
              "name": "min_profit_margin",
              "value": "30"
            },
            {
              "name": "apify_token",
              "value": "={{ $env.APIFY_API_TOKEN }}"
            },
            {
              "name": "gemini_key",
              "value": "={{ $env.GEMINI_API_KEY }}"
            },
            {
              "name": "youtube_key",
              "value": "={{ $env.YOUTUBE_API_KEY }}"
            },
            {
              "name": "serpapi_key",
              "value": "={{ $env.SERPAPI_KEY }}"
            }
          ]
        },
        "options": {}
      },
      "id": "node-input",
      "name": "ğŸ“ Product Input & Config",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.3,
      "position": [450, 400],
      "notes": "Configure product search and API credentials"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://api.apify.com/v2/acts/BG3WDrGdteHgZgbPK/runs?token={{ $json.apify_token }}",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"startUrls\": [{\n    \"url\": \"https://www.amazon.com/s?k={{ $json.product_keyword.replace(' ', '+') }}\"\n  }],\n  \"maxItems\": 5,\n  \"proxyConfiguration\": {\n    \"useApifyProxy\": true\n  }\n}",
        "options": {
          "timeout": 180000
        }
      },
      "id": "node-amazon-start",
      "name": "ğŸ›’ Start Amazon Scrape",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [650, 400],
      "notes": "Starts Apify Amazon actor via REST API",
      "continueOnFail": true
    },
    {
      "parameters": {
        "amount": 15,
        "unit": "seconds"
      },
      "id": "node-wait-amazon",
      "name": "â³ Wait for Amazon Results",
      "type": "n8n-nodes-base.wait",
      "typeVersion": 1.1,
      "position": [850, 400],
      "notes": "Wait for Apify actor to complete scraping",
      "webhookId": "wait-amazon"
    },
    {
      "parameters": {
        "url": "=https://api.apify.com/v2/datasets/{{ $json.data.defaultDatasetId }}/items?token={{ $('ğŸ“ Product Input & Config').item.json.apify_token }}",
        "options": {
          "timeout": 30000
        }
      },
      "id": "node-amazon-results",
      "name": "ğŸ“¦ Get Amazon Results",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [1050, 400],
      "notes": "Fetch Amazon product data from Apify dataset",
      "continueOnFail": true
    },
    {
      "parameters": {
        "jsCode": "// Process Amazon results and extract first product\nconst items = $input.all();\nconst productKeyword = $('ğŸ“ Product Input & Config').item.json.product_keyword;\n\nlet selectedProduct = {\n  title: `Sample ${productKeyword}`,\n  price: 39.99,\n  asin: 'B0DEMO123',\n  url: 'https://amazon.com/dp/B0DEMO123',\n  rating: 4.3,\n  reviews: 850\n};\n\n// Try to extract real product data\nif (items.length > 0 && items[0].json && Array.isArray(items[0].json)) {\n  const products = items[0].json;\n  if (products.length > 0) {\n    const product = products[0];\n    selectedProduct = {\n      title: product.title || selectedProduct.title,\n      price: product.price?.value || product.price || selectedProduct.price,\n      asin: product.asin || selectedProduct.asin,\n      url: product.url || selectedProduct.url,\n      rating: product.rating || selectedProduct.rating,\n      reviews: product.reviewsCount || product.reviews || selectedProduct.reviews\n    };\n  }\n}\n\nreturn {\n  amazon_product: selectedProduct,\n  search_keyword: productKeyword,\n  products_found: 1\n};"
      },
      "id": "node-process-amazon",
      "name": "ğŸ”§ Process Amazon Data",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1250, 400],
      "notes": "JavaScript code to extract first product (NO IMPORTS)",
      "onError": "continueErrorOutput"
    },
    {
      "parameters": {},
      "id": "node-split",
      "name": "âš¡ Parallel Processing",
      "type": "n8n-nodes-base.splitOut",
      "typeVersion": 1,
      "position": [1450, 400],
      "notes": "Split for parallel API calls"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://generativelanguage.googleapis.com/v1beta/models/gemini-pro:generateContent?key={{ $('ğŸ“ Product Input & Config').item.json.gemini_key }}",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"contents\": [{\n    \"parts\": [{\n      \"text\": \"Analyze this product for dropshipping: {{ $json.amazon_product.title }}. Price: ${{ $json.amazon_product.price }}. Reviews: {{ $json.amazon_product.reviews }}. Rating: {{ $json.amazon_product.rating }}. Score these 9 criteria (1-10 each): 1.Confidence 2.Convenience 3.Fills Void 4.Saves Money 5.Saves Time 6.Unique 7.Not in Stores 8.Quality of Life 9.Perceived Value. Return ONLY this JSON format: {total_score:80, passed_criteria:7, recommendation:'pass'}\"\n    }]\n  }],\n  \"generationConfig\": {\n    \"temperature\": 0.3\n  }\n}",
        "options": {
          "timeout": 30000,
          "retry": {
            "maxTries": 2,
            "waitBetweenTries": 2000
          }
        }
      },
      "id": "node-gemini",
      "name": "ğŸ¤– AI Product Validation",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [1650, 200],
      "notes": "Gemini AI validates product",
      "continueOnFail": true
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://api.apify.com/v2/acts/LEqVhe8SqCDdpdXjw/runs?token={{ $('ğŸ“ Product Input & Config').item.json.apify_token }}",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"startUrls\": [{\n    \"url\": \"https://www.aliexpress.com/w/wholesale-{{ $json.search_keyword.replace(' ', '-') }}.html\"\n  }],\n  \"maxItems\": 10,\n  \"proxyConfiguration\": {\n    \"useApifyProxy\": true\n  }\n}",
        "options": {
          "timeout": 180000
        }
      },
      "id": "node-ali-start",
      "name": "ğŸ­ Start AliExpress Scrape",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [1650, 400],
      "notes": "Starts Apify AliExpress actor",
      "continueOnFail": true
    },
    {
      "parameters": {
        "url": "=https://serpapi.com/search?engine=google_trends&q={{ $json.search_keyword }}&data_type=TIMESERIES&date=today 3-m&geo=US&api_key={{ $('ğŸ“ Product Input & Config').item.json.serpapi_key }}",
        "options": {
          "timeout": 30000,
          "retry": {
            "maxTries": 2,
            "waitBetweenTries": 2000
          }
        }
      },
      "id": "node-trends",
      "name": "ğŸ“ˆ Google Trends",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [1650, 600],
      "notes": "Get Google Trends data",
      "continueOnFail": true
    },
    {
      "parameters": {
        "amount": 15,
        "unit": "seconds"
      },
      "id": "node-wait-ali",
      "name": "â³ Wait for AliExpress",
      "type": "n8n-nodes-base.wait",
      "typeVersion": 1.1,
      "position": [1850, 400],
      "notes": "Wait for AliExpress scrape to complete",
      "webhookId": "wait-aliexpress"
    },
    {
      "parameters": {
        "url": "=https://api.apify.com/v2/datasets/{{ $json.data.defaultDatasetId }}/items?token={{ $('ğŸ“ Product Input & Config').item.json.apify_token }}",
        "options": {
          "timeout": 30000
        }
      },
      "id": "node-ali-results",
      "name": "ğŸ“¦ Get AliExpress Results",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [2050, 400],
      "notes": "Fetch AliExpress data",
      "continueOnFail": true
    },
    {
      "parameters": {
        "jsCode": "// Calculate profit margins for AliExpress suppliers\nconst items = $input.all();\nconst amazonProduct = $('ğŸ”§ Process Amazon Data').item.json.amazon_product;\nconst amazonPrice = parseFloat(amazonProduct.price) || 49.99;\nconst searchKeyword = $('ğŸ”§ Process Amazon Data').item.json.search_keyword;\n\nlet bestSupplier = {\n  supplier_title: `Wholesale ${searchKeyword}`,\n  supplier_price: 12.99,\n  shipping_cost: 3.99,\n  total_cost: 16.98,\n  amazon_price: amazonPrice,\n  profit_margin: 66.05,\n  roi_percentage: 194.52,\n  profitable: true\n};\n\n// Try to process real AliExpress data\nif (items.length > 0 && items[0].json && Array.isArray(items[0].json)) {\n  const suppliers = items[0].json.slice(0, 5); // Top 5\n  const matches = [];\n  \n  for (const supplier of suppliers) {\n    const supplierPrice = parseFloat(supplier.price?.value || supplier.price || 15);\n    const shippingCost = parseFloat(supplier.shipping?.value || supplier.shipping || 3.99);\n    const totalCost = supplierPrice + shippingCost;\n    \n    const profitMargin = amazonPrice > 0 && totalCost > 0 \n      ? ((amazonPrice - totalCost) / amazonPrice) * 100 \n      : 0;\n    const roi = totalCost > 0 \n      ? ((amazonPrice - totalCost) / totalCost) * 100 \n      : 0;\n    \n    matches.push({\n      supplier_title: supplier.title || 'Unknown',\n      supplier_price: supplierPrice,\n      shipping_cost: shippingCost,\n      total_cost: totalCost,\n      amazon_price: amazonPrice,\n      profit_margin: Math.round(profitMargin * 100) / 100,\n      roi_percentage: Math.round(roi * 100) / 100,\n      profitable: profitMargin >= 30\n    });\n  }\n  \n  if (matches.length > 0) {\n    matches.sort((a, b) => b.profit_margin - a.profit_margin);\n    bestSupplier = matches[0];\n  }\n}\n\nreturn {\n  amazon_product: amazonProduct.title,\n  amazon_price: amazonPrice,\n  best_supplier: bestSupplier,\n  suppliers_found: 1\n};"
      },
      "id": "node-process-ali",
      "name": "ğŸ”§ Calculate Margins",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [2250, 400],
      "notes": "JavaScript: Calculate profit margins (NO IMPORTS)",
      "onError": "continueErrorOutput"
    },
    {
      "parameters": {
        "mode": "mergeByPosition"
      },
      "id": "node-merge",
      "name": "ğŸ”„ Merge All Data",
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3,
      "position": [2450, 400],
      "notes": "Combine all analysis data"
    },
    {
      "parameters": {
        "url": "=https://www.googleapis.com/youtube/v3/search?part=snippet&q={{ $('ğŸ”§ Process Amazon Data').item.json.search_keyword }} review&type=video&maxResults=25&order=viewCount&key={{ $('ğŸ“ Product Input & Config').item.json.youtube_key }}",
        "options": {
          "timeout": 30000,
          "retry": {
            "maxTries": 2,
            "waitBetweenTries": 2000
          }
        }
      },
      "id": "node-youtube",
      "name": "ğŸ“¹ YouTube Validation",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [2650, 400],
      "notes": "Check YouTube market interest",
      "continueOnFail": true
    },
    {
      "parameters": {
        "jsCode": "// Final analysis and decision making\nconst data = $input.item.json;\n\n// Extract metrics\nconst amazonPrice = data.amazon_price || 49.99;\nconst bestSupplier = data.best_supplier || {};\nconst profitMargin = bestSupplier.profit_margin || 0;\nconst youtubeResults = data.pageInfo?.totalResults || 0;\n\n// Parse AI validation\nlet aiCriteriaPassed = 5;\ntry {\n  const aiResponse = data.candidates?.[0]?.content?.parts?.[0]?.text || '{}';\n  const jsonMatch = aiResponse.match(/\\{[^}]+\\}/);\n  if (jsonMatch) {\n    const aiData = JSON.parse(jsonMatch[0]);\n    aiCriteriaPassed = aiData.passed_criteria || 5;\n  }\n} catch (e) {\n  // Use default\n}\n\n// Parse trends\nlet trendScore = 50;\ntry {\n  const trendsData = data.interest_over_time?.timeline_data || [];\n  if (trendsData.length > 0) {\n    trendScore = trendsData[trendsData.length - 1]?.values?.[0]?.value || 50;\n  }\n} catch (e) {\n  // Use default\n}\n\n// Calculate score\nlet score = 0;\nconst reasons = [];\n\n// Profit margin (40 points)\nif (profitMargin >= 40) {\n  score += 40;\n  reasons.push(`âœ… Excellent profit margin: ${profitMargin}%`);\n} else if (profitMargin >= 25) {\n  score += 25;\n  reasons.push(`âœ… Good profit margin: ${profitMargin}%`);\n} else if (profitMargin >= 15) {\n  score += 15;\n  reasons.push(`âš ï¸ Acceptable profit margin: ${profitMargin}%`);\n} else {\n  reasons.push(`âŒ Low profit margin: ${profitMargin}%`);\n}\n\n// AI validation (30 points)\nif (aiCriteriaPassed >= 5) {\n  score += 30;\n  reasons.push(`âœ… Passed ${aiCriteriaPassed}/9 AI criteria`);\n} else {\n  score += 15;\n  reasons.push(`âš ï¸ Passed ${aiCriteriaPassed}/9 AI criteria`);\n}\n\n// YouTube interest (20 points)\nif (youtubeResults >= 100) {\n  score += 20;\n  reasons.push(`âœ… High YouTube interest: ${youtubeResults} videos`);\n} else if (youtubeResults >= 25) {\n  score += 10;\n  reasons.push(`âš ï¸ Moderate YouTube interest: ${youtubeResults} videos`);\n} else {\n  reasons.push(`âŒ Low YouTube interest: ${youtubeResults} videos`);\n}\n\n// Trend score (10 points)\nif (trendScore >= 50) {\n  score += 10;\n  reasons.push(`âœ… Trending upward: ${trendScore}`);\n} else {\n  reasons.push(`âš ï¸ Trend score: ${trendScore}`);\n}\n\n// Final decision\nlet decision, action;\nif (score >= 60) {\n  decision = 'âœ… APPROVED - PROCEED WITH PRODUCT';\n  action = 'Add to inventory immediately';\n} else if (score >= 40) {\n  decision = 'âš ï¸ CONDITIONAL - NEEDS REVIEW';\n  action = 'Manual review recommended';\n} else {\n  decision = 'âŒ REJECTED - FIND ALTERNATIVE';\n  action = 'Search for better products';\n}\n\nconst now = new Date();\nreturn {\n  timestamp: now.toISOString(),\n  product: data.amazon_product || 'Unknown Product',\n  decision: decision,\n  confidence_score: score,\n  action_required: action,\n  analysis_reasons: reasons,\n  key_metrics: {\n    amazon_price: amazonPrice,\n    supplier_cost: bestSupplier.total_cost || 0,\n    profit_margin: profitMargin,\n    roi: bestSupplier.roi_percentage || 0,\n    youtube_videos: youtubeResults,\n    trend_score: trendScore,\n    ai_criteria_passed: aiCriteriaPassed\n  },\n  supplier_details: {\n    supplier_name: bestSupplier.supplier_title || 'Unknown',\n    total_cost: bestSupplier.total_cost || 0\n  }\n};"
      },
      "id": "node-final-analysis",
      "name": "ğŸ¯ Final Analysis",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [2850, 400],
      "notes": "JavaScript: Make final decision (NO IMPORTS)",
      "onError": "continueErrorOutput"
    },
    {
      "parameters": {
        "values": {
          "string": [
            {
              "name": "result_summary",
              "value": "={{ $json.decision }}\\n\\nProduct: {{ $json.product }}\\nScore: {{ $json.confidence_score }}/100\\nProfit Margin: {{ $json.key_metrics.profit_margin }}%\\nROI: {{ $json.key_metrics.roi }}%\\n\\nAction: {{ $json.action_required }}"
            },
            {
              "name": "timestamp",
              "value": "={{ $json.timestamp }}"
            },
            {
              "name": "decision",
              "value": "={{ $json.decision }}"
            },
            {
              "name": "score",
              "value": "={{ $json.confidence_score }}"
            }
          ]
        },
        "options": {}
      },
      "id": "node-display",
      "name": "ğŸ‰ Display Results",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.3,
      "position": [3050, 400],
      "notes": "Show final results to user"
    }
  ],
  "connections": {
    "ğŸš€ Start Research": {
      "main": [
        [
          {
            "node": "ğŸ“ Product Input & Config",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ“ Product Input & Config": {
      "main": [
        [
          {
            "node": "ğŸ›’ Start Amazon Scrape",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ›’ Start Amazon Scrape": {
      "main": [
        [
          {
            "node": "â³ Wait for Amazon Results",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "â³ Wait for Amazon Results": {
      "main": [
        [
          {
            "node": "ğŸ“¦ Get Amazon Results",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ“¦ Get Amazon Results": {
      "main": [
        [
          {
            "node": "ğŸ”§ Process Amazon Data",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ”§ Process Amazon Data": {
      "main": [
        [
          {
            "node": "âš¡ Parallel Processing",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "âš¡ Parallel Processing": {
      "main": [
        [
          {
            "node": "ğŸ¤– AI Product Validation",
            "type": "main",
            "index": 0
          },
          {
            "node": "ğŸ­ Start AliExpress Scrape",
            "type": "main",
            "index": 0
          },
          {
            "node": "ğŸ“ˆ Google Trends",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ¤– AI Product Validation": {
      "main": [
        [
          {
            "node": "ğŸ”„ Merge All Data",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ­ Start AliExpress Scrape": {
      "main": [
        [
          {
            "node": "â³ Wait for AliExpress",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ“ˆ Google Trends": {
      "main": [
        [
          {
            "node": "ğŸ”„ Merge All Data",
            "type": "main",
            "index": 2
          }
        ]
      ]
    },
    "â³ Wait for AliExpress": {
      "main": [
        [
          {
            "node": "ğŸ“¦ Get AliExpress Results",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ“¦ Get AliExpress Results": {
      "main": [
        [
          {
            "node": "ğŸ”§ Calculate Margins",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ”§ Calculate Margins": {
      "main": [
        [
          {
            "node": "ğŸ”„ Merge All Data",
            "type": "main",
            "index": 1
          }
        ]
      ]
    },
    "ğŸ”„ Merge All Data": {
      "main": [
        [
          {
            "node": "ğŸ“¹ YouTube Validation",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ“¹ YouTube Validation": {
      "main": [
        [
          {
            "node": "ğŸ¯ Final Analysis",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ¯ Final Analysis": {
      "main": [
        [
          {
            "node": "ğŸ‰ Display Results",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "pinData": {},
  "settings": {
    "executionOrder": "v1",
    "saveManualExecutions": true,
    "callerPolicy": "workflowsFromSameOwner",
    "executionTimeout": 600
  },
  "staticData": null,
  "tags": [],
  "triggerCount": 1,
  "updatedAt": "2025-11-17T00:00:00.000Z",
  "versionId": "4"
}
